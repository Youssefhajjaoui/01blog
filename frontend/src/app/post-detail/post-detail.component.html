<app-navbar [currentPage]="'post'" [searchQuery]="''" (searchChange)="onSearchChange($event)"
    (notificationClick)="onNotificationClick()" (userClick)="onUserClick()" (navigate)="onNavigate($event.page)">
</app-navbar>

<div class="post-detail-page">
    <div class="container">
        <div class="post-detail-grid">
            <!-- Main Post Content -->
            <div class="post-content-section">
                <!-- Loading State -->
                <div *ngIf="loading" class="loading-state">
                    <div class="skeleton-post">
                        <div class="skeleton-header">
                            <div class="skeleton-avatar"></div>
                            <div class="skeleton-info">
                                <div class="skeleton-line skeleton-line-md"></div>
                                <div class="skeleton-line skeleton-line-sm"></div>
                            </div>
                        </div>
                        <div class="skeleton-title"></div>
                        <div class="skeleton-text"></div>
                        <div class="skeleton-text"></div>
                        <div class="skeleton-image"></div>
                    </div>
                </div>

                <!-- Post Content -->
                <article *ngIf="!loading && post" class="post-card">
                    <!-- Post Header -->
                    <header class="post-header">
                        <div class="author-info" (click)="navigateToProfile(post.author.id)">
                            <img [src]="getUserAvatarUrl(post.author)" [alt]="post.author.username"
                                class="author-avatar" />
                            <div class="author-details">
                                <h3 class="author-name">{{ post.author.username }}</h3>
                                <time class="post-date">{{ formatDate(post.createdAt) }}</time>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <button *ngIf="post.author.id !== currentUser?.id" class="follow-btn"
                                [class.following]="post.isSubscribed" (click)="handleSubscribe()">
                                {{ post.isSubscribed ? 'Following' : 'Follow' }}
                            </button>

                            <!-- Menu Button -->
                            <div class="menu-wrapper">
                                <button class="menu-btn" (click)="showMenu.set(!showMenu()); $event.stopPropagation()">
                                    <svg class="menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                                    </svg>
                                </button>
                                <div *ngIf="showMenu()" class="menu-dropdown">
                                    <button *ngIf="isOwner && !editMode()" class="menu-item"
                                        (click)="handleEdit($event)">
                                        <svg class="menu-item-icon" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                        Edit
                                    </button>
                                    <button *ngIf="isOwner || isAdmin" class="menu-item menu-item-danger"
                                        (click)="handleDelete($event)">
                                        <svg class="menu-item-icon" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                        Delete
                                    </button>
                                    <button *ngIf="isAdmin && !post.hidden" class="menu-item menu-item-warning"
                                        (click)="handleHide($event)">
                                        <svg class="menu-item-icon" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                                        </svg>
                                        Hide Post
                                    </button>
                                    <button *ngIf="isAdmin && post.hidden" class="menu-item menu-item-success"
                                        (click)="handleRestore($event)">
                                        <svg class="menu-item-icon" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                        </svg>
                                        Restore Post
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <!-- Hidden Post Warning (for admins and post creators) -->
                    <div *ngIf="post.hidden && (isAdmin || isOwner)" class="hidden-post-warning">
                        <div class="hidden-post-icon">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                        <div class="hidden-post-content">
                            <strong class="hidden-post-title">This post has been hidden</strong>
                            <p class="hidden-post-reason" *ngIf="post.hideReason">
                                Reason: {{ post.hideReason }}
                            </p>
                            <p class="hidden-post-reason" *ngIf="!post.hideReason">
                                No specific reason provided
                            </p>
                        </div>
                    </div>

                    <!-- Post Title and Content -->
                    <div *ngIf="!post.hidden">
                        <ng-container *ngIf="!editMode(); else editFields">
                            <h1 class="post-title">{{ post.title }}</h1>

                            <!-- Post Tags -->
                            <div *ngIf="post.tags && post.tags.length > 0" class="post-tags">
                                <span *ngFor="let tag of post.tags" class="tag-badge">#{{ tag }}</span>
                            </div>

                            <!-- Post Media -->
                            <div *ngIf="post.media != undefined" class="post-media">
                                <img *ngIf="post.media[0]?.type === 'IMAGE'" [src]="getPostMediaUrl()"
                                    [alt]="post.title" class="media-image" />
                                <video *ngIf="post.media[0]?.type === 'VIDEO'" [src]="getPostMediaUrl()" controls
                                    class="media-video"></video>
                                <audio *ngIf="post.media[0]?.type === 'AUDIO'" [src]="getPostMediaUrl()" controls
                                    class="media-audio"></audio>
                            </div>

                            <!-- Post Content -->
                            <div class="post-body" [innerHTML]="post.content | markdown"></div>
                        </ng-container>

                        <ng-template #editFields>
                            <input type="text" class="edit-input title-input" [ngModel]="editablePost().title"
                                (ngModelChange)="updateEditableTitle($event)" placeholder="Post title" />
                            <textarea class="edit-textarea excerpt-input" [ngModel]="editablePost().content"
                                (ngModelChange)="updateEditableContent($event)" placeholder="Post content"
                                rows="10"></textarea>

                            <!-- Media editing section -->
                            <div class="edit-media-section">
                                <!-- Original media from post creation -->
                                <div *ngIf="getOriginalMediaUrl()" class="original-media-section">
                                    <div class="media-section-header">
                                        <span class="media-label">Original Media</span>
                                        <div class="media-actions">
                                            <button type="button" class="btn-keep-original"
                                                [class.active]="editablePost().mediaUrl === getOriginalMediaUrl()"
                                                (click)="keepOriginalMedia($event)" title="Keep original media">
                                                Keep Original
                                            </button>
                                            <button type="button" class="btn-remove-all"
                                                (click)="removeAllMedia($event)" title="Remove all media">
                                                Remove All
                                            </button>
                                        </div>
                                    </div>
                                    <div class="original-media-preview">
                                        <img *ngIf="getOriginalMediaType() === 'IMAGE'" [src]="getOriginalMediaUrl()"
                                            class="media-preview-img" alt="Original media" />
                                        <video *ngIf="getOriginalMediaType() === 'VIDEO'" [src]="getOriginalMediaUrl()"
                                            class="media-preview-video" controls></video>
                                        <audio *ngIf="getOriginalMediaType() === 'AUDIO'" [src]="getOriginalMediaUrl()"
                                            class="media-preview-audio" controls></audio>
                                    </div>
                                </div>

                                <!-- Currently selected/uploaded media (if different from original) -->
                                <div *ngIf="editablePost().mediaUrl && editablePost().mediaUrl !== getOriginalMediaUrl()"
                                    class="new-media-section">
                                    <div class="media-section-header">
                                        <span class="media-label">New Upload (will replace original)</span>
                                        <button type="button" class="btn-remove-new" (click)="removeNewMedia($event)"
                                            title="Cancel this upload">
                                            Cancel
                                        </button>
                                    </div>
                                    <div class="new-media-preview">
                                        <img *ngIf="editablePost().mediaType === 'IMAGE'"
                                            [src]="editablePost().mediaUrl" class="media-preview-img" alt="New media" />
                                        <video *ngIf="editablePost().mediaType === 'VIDEO'"
                                            [src]="editablePost().mediaUrl" class="media-preview-video"
                                            controls></video>
                                        <audio *ngIf="editablePost().mediaType === 'AUDIO'"
                                            [src]="editablePost().mediaUrl" class="media-preview-audio"
                                            controls></audio>
                                    </div>
                                </div>

                                <!-- No media state -->
                                <div *ngIf="!editablePost().mediaUrl && !getOriginalMediaUrl()" class="no-media-state">
                                    <p class="no-media-text">No media attached</p>
                                </div>

                                <!-- Upload button -->
                                <div class="upload-media-section">
                                    <label class="upload-label">
                                        <input type="file" class="file-input" accept="image/*,video/*,audio/*"
                                            (change)="onFileSelected($event)" />
                                        <div class="upload-button">
                                            Upload Media
                                        </div>
                                    </label>
                                    <span *ngIf="uploadingMedia()" class="upload-status">Uploading...</span>
                                    <span *ngIf="uploadError()" class="upload-error">{{ uploadError() }}</span>
                                </div>
                            </div>

                            <!-- Edit Save/Cancel buttons -->
                            <div class="edit-actions" *ngIf="editMode()">
                                <button class="btn-save" (click)="saveEdit($event)">Save</button>
                                <button class="btn-cancel" (click)="cancelEdit($event)">Cancel</button>
                            </div>
                        </ng-template>
                    </div>

                    <!-- Post Actions -->
                    <footer *ngIf="!post.hidden && !editMode()" class="post-actions">
                        <button class="action-btn" [class.active]="post.isLiked" (click)="handleLike()">
                            <svg class="action-icon" fill="currentColor" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                            </svg>
                            <span class="action-text">{{ post.likes }} {{ post.likes === 1 ? 'Like' : 'Likes' }}</span>
                        </button>

                        <button class="action-btn">
                            <svg class="action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                            </svg>
                            <span class="action-text">{{ post.comments }} {{ post.comments === 1 ? 'Comment' :
                                'Comments' }}</span>
                        </button>
                    </footer>
                </article>

                <!-- Comments Section -->
                <section *ngIf="!loading && post && !post.hidden" class="comments-section">
                    <h2 class="comments-title">Comments ({{ post.comments }})</h2>

                    <!-- Add Comment Form -->
                    <div *ngIf="currentUser" class="add-comment-form">
                        <img [src]="getUserAvatarUrl(currentUser)" [alt]="currentUser.username"
                            class="comment-avatar" />
                        <div class="comment-input-wrapper">
                            <textarea [(ngModel)]="newCommentContent" placeholder="Add a comment..."
                                class="comment-input" rows="3" [disabled]="submittingComment"></textarea>
                            <button class="submit-comment-btn" (click)="submitComment()"
                                [disabled]="!newCommentContent.trim() || submittingComment">
                                {{ submittingComment ? 'Posting...' : 'Post Comment' }}
                            </button>
                        </div>
                    </div>

                    <!-- Comments List -->
                    <div class="comments-list">
                        <!-- Loading Comments -->
                        <div *ngIf="loadingComments" class="loading-comments">
                            <div *ngFor="let item of [1, 2, 3]" class="skeleton-comment">
                                <div class="skeleton-avatar"></div>
                                <div class="skeleton-comment-content">
                                    <div class="skeleton-line skeleton-line-sm"></div>
                                    <div class="skeleton-line skeleton-line-md"></div>
                                </div>
                            </div>
                        </div>

                        <!-- No Comments -->
                        <div *ngIf="!loadingComments && comments.length === 0" class="no-comments">
                            <svg class="no-comments-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                            </svg>
                            <p class="no-comments-text">No comments yet. Be the first to comment!</p>
                        </div>

                        <!-- Comment Items -->
                        <div *ngFor="let comment of comments" class="comment-item">
                            <img [src]="getUserAvatarUrl(comment.author)" [alt]="comment.author.username"
                                class="comment-avatar" (click)="navigateToProfile(comment.author.id)" />
                            <div class="comment-content">
                                <div class="comment-header">
                                    <span class="comment-author" (click)="navigateToProfile(comment.author.id)">{{
                                        comment.author.username
                                        }}</span>
                                    <span class="comment-date">{{ formatTimeAgo(comment.createdAt) }}</span>
                                </div>

                                <!-- Comment Text (View Mode) -->
                                <p *ngIf="editingCommentId !== comment.id" class="comment-text">{{ comment.content }}
                                </p>

                                <!-- Comment Edit Form -->
                                <div *ngIf="editingCommentId === comment.id" class="comment-edit-form">
                                    <textarea [(ngModel)]="editingCommentContent" class="comment-input" rows="2"
                                        [disabled]="updatingComment"></textarea>
                                    <div class="comment-edit-actions">
                                        <button class="cancel-btn" (click)="cancelEditComment()"
                                            [disabled]="updatingComment">
                                            Cancel
                                        </button>
                                        <button class="save-btn" (click)="updateComment(comment.id)"
                                            [disabled]="!editingCommentContent.trim() || updatingComment">
                                            {{ updatingComment ? 'Saving...' : 'Save' }}
                                        </button>
                                    </div>
                                </div>

                                <!-- Comment Actions -->
                                <div class="comment-actions">
                                    <button
                                        *ngIf="comment.author.id === currentUser?.id && editingCommentId !== comment.id"
                                        class="comment-action-btn" (click)="startEditComment(comment)">
                                        <svg class="action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                        Edit
                                    </button>
                                    <button
                                        *ngIf="(comment.author.id === currentUser?.id || isAdmin) && editingCommentId !== comment.id"
                                        class="comment-action-btn delete-btn" (click)="deleteComment(comment.id)">
                                        <svg class="action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                                        </svg>
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Sidebar -->
            <aside class="sidebar">
                <!-- Author Card -->
                <div *ngIf="post" class="author-card">
                    <div class="author-card-header">
                        <img [src]="getUserAvatarUrl(post.author)" [alt]="post.author.username"
                            class="author-card-avatar" />
                    </div>
                    <div class="author-card-body">
                        <h3 class="author-card-name" (click)="navigateToProfile(post.author.id)">{{ post.author.username
                            }}</h3>
                        <p *ngIf="post.author.bio" class="author-card-bio">{{ post.author.bio }}</p>
                        <div class="author-stats">
                            <div class="stat">
                                <span class="stat-value">{{ post.author.posts }}</span>
                                <span class="stat-label">Posts</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value">{{ post.author.followers }}</span>
                                <span class="stat-label">Followers</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value">{{ post.author.following }}</span>
                                <span class="stat-label">Following</span>
                            </div>
                        </div>
                        <button *ngIf="post.author.id !== currentUser?.id" class="follow-author-btn"
                            [class.following]="post.isSubscribed" (click)="handleSubscribe()">
                            {{ post.isSubscribed ? 'Following' : 'Follow' }}
                        </button>
                    </div>
                </div>

                <!-- More from Author -->
                <!-- This could be implemented later to show more posts from the same author -->
            </aside>
        </div>
    </div>
</div>